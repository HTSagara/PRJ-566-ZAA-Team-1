{"version":3,"file":"signOut.js","sources":["../../../../../src/providers/cognito/apis/signOut.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.signOut = void 0;\nconst core_1 = require(\"@aws-amplify/core\");\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst utils_2 = require(\"../../../utils\");\nconst tokenProvider_1 = require(\"../tokenProvider\");\nconst parsers_1 = require(\"../../../foundation/parsers\");\nconst types_1 = require(\"../utils/types\");\nconst oauth_1 = require(\"../utils/oauth\");\nconst signInWithRedirectStore_1 = require(\"../utils/signInWithRedirectStore\");\nconst AuthError_1 = require(\"../../../errors/AuthError\");\nconst constants_1 = require(\"../../../errors/constants\");\nconst cognitoIdentityProvider_1 = require(\"../../../foundation/factories/serviceClients/cognitoIdentityProvider\");\nconst factories_1 = require(\"../factories\");\nconst logger = new core_1.ConsoleLogger('Auth');\n/**\n * Signs a user out\n *\n * @param input - The SignOutInput object\n * @throws AuthTokenConfigException - Thrown when the token provider config is invalid.\n */\nasync function signOut(input) {\n    const cognitoConfig = core_1.Amplify.getConfig().Auth?.Cognito;\n    (0, utils_1.assertTokenProviderConfig)(cognitoConfig);\n    if (input?.global) {\n        await globalSignOut(cognitoConfig);\n    }\n    else {\n        await clientSignOut(cognitoConfig);\n    }\n    let hasOAuthConfig;\n    try {\n        (0, utils_1.assertOAuthConfig)(cognitoConfig);\n        hasOAuthConfig = true;\n    }\n    catch (err) {\n        hasOAuthConfig = false;\n    }\n    if (hasOAuthConfig) {\n        const oAuthStore = new signInWithRedirectStore_1.DefaultOAuthStore(core_1.defaultStorage);\n        oAuthStore.setAuthConfig(cognitoConfig);\n        const { type } = (await (0, oauth_1.handleOAuthSignOut)(cognitoConfig, oAuthStore, tokenProvider_1.tokenOrchestrator, input?.oauth?.redirectUrl)) ?? {};\n        if (type === 'error') {\n            throw new AuthError_1.AuthError({\n                name: constants_1.OAUTH_SIGNOUT_EXCEPTION,\n                message: `An error occurred when attempting to log out from OAuth provider.`,\n            });\n        }\n    }\n    else {\n        // complete sign out\n        tokenProvider_1.tokenOrchestrator.clearTokens();\n        await (0, core_1.clearCredentials)();\n        core_1.Hub.dispatch('auth', { event: 'signedOut' }, 'Auth', utils_1.AMPLIFY_SYMBOL);\n    }\n}\nexports.signOut = signOut;\nasync function clientSignOut(cognitoConfig) {\n    try {\n        const { userPoolEndpoint, userPoolId, userPoolClientId } = cognitoConfig;\n        const authTokens = await tokenProvider_1.tokenOrchestrator.getTokenStore().loadTokens();\n        (0, types_1.assertAuthTokensWithRefreshToken)(authTokens);\n        if (isSessionRevocable(authTokens.accessToken)) {\n            const revokeToken = (0, cognitoIdentityProvider_1.createRevokeTokenClient)({\n                endpointResolver: (0, factories_1.createCognitoUserPoolEndpointResolver)({\n                    endpointOverride: userPoolEndpoint,\n                }),\n            });\n            await revokeToken({\n                region: (0, parsers_1.getRegionFromUserPoolId)(userPoolId),\n                userAgentValue: (0, utils_2.getAuthUserAgentValue)(utils_1.AuthAction.SignOut),\n            }, {\n                ClientId: userPoolClientId,\n                Token: authTokens.refreshToken,\n            });\n        }\n    }\n    catch (err) {\n        // this shouldn't throw\n        logger.debug('Client signOut error caught but will proceed with token removal');\n    }\n}\nasync function globalSignOut(cognitoConfig) {\n    try {\n        const { userPoolEndpoint, userPoolId } = cognitoConfig;\n        const authTokens = await tokenProvider_1.tokenOrchestrator.getTokenStore().loadTokens();\n        (0, types_1.assertAuthTokens)(authTokens);\n        const globalSignOutClient = (0, cognitoIdentityProvider_1.createGlobalSignOutClient)({\n            endpointResolver: (0, factories_1.createCognitoUserPoolEndpointResolver)({\n                endpointOverride: userPoolEndpoint,\n            }),\n        });\n        await globalSignOutClient({\n            region: (0, parsers_1.getRegionFromUserPoolId)(userPoolId),\n            userAgentValue: (0, utils_2.getAuthUserAgentValue)(utils_1.AuthAction.SignOut),\n        }, {\n            AccessToken: authTokens.accessToken.toString(),\n        });\n    }\n    catch (err) {\n        // it should not throw\n        logger.debug('Global signOut error caught but will proceed with token removal');\n    }\n}\nconst isSessionRevocable = (token) => !!token?.payload?.origin_jti;\n"],"names":[],"mappings":"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"}