{"version":3,"file":"multiAuthStrategy.js","sources":["../../../src/authModeStrategies/multiAuthStrategy.ts"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.multiAuthStrategy = void 0;\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nconst core_1 = require(\"@aws-amplify/core\");\nconst types_1 = require(\"../types\");\nfunction getProviderFromRule(rule) {\n    // private with no provider means userPools\n    if (rule.allow === 'private' && !rule.provider) {\n        return types_1.ModelAttributeAuthProvider.USER_POOLS;\n    }\n    // public with no provider means apiKey\n    if (rule.allow === 'public' && !rule.provider) {\n        return types_1.ModelAttributeAuthProvider.API_KEY;\n    }\n    return rule.provider;\n}\nfunction sortAuthRulesWithPriority(rules) {\n    const allowSortPriority = [\n        types_1.ModelAttributeAuthAllow.CUSTOM,\n        types_1.ModelAttributeAuthAllow.OWNER,\n        types_1.ModelAttributeAuthAllow.GROUPS,\n        types_1.ModelAttributeAuthAllow.PRIVATE,\n        types_1.ModelAttributeAuthAllow.PUBLIC,\n    ];\n    const providerSortPriority = [\n        types_1.ModelAttributeAuthProvider.FUNCTION,\n        types_1.ModelAttributeAuthProvider.USER_POOLS,\n        types_1.ModelAttributeAuthProvider.OIDC,\n        types_1.ModelAttributeAuthProvider.IAM,\n        types_1.ModelAttributeAuthProvider.API_KEY,\n    ];\n    return [...rules].sort((a, b) => {\n        if (a.allow === b.allow) {\n            return (providerSortPriority.indexOf(getProviderFromRule(a)) -\n                providerSortPriority.indexOf(getProviderFromRule(b)));\n        }\n        return (allowSortPriority.indexOf(a.allow) - allowSortPriority.indexOf(b.allow));\n    });\n}\nfunction getAuthRules({ rules, currentUser, }) {\n    // Using Set to ensure uniqueness\n    const authModes = new Set();\n    rules.forEach(rule => {\n        switch (rule.allow) {\n            case types_1.ModelAttributeAuthAllow.CUSTOM:\n                // custom with no provider -> function\n                if (!rule.provider ||\n                    rule.provider === types_1.ModelAttributeAuthProvider.FUNCTION) {\n                    authModes.add('lambda');\n                }\n                break;\n            case types_1.ModelAttributeAuthAllow.GROUPS:\n            case types_1.ModelAttributeAuthAllow.OWNER: {\n                // We shouldn't attempt User Pool or OIDC if there isn't an authenticated user\n                if (currentUser) {\n                    if (rule.provider === types_1.ModelAttributeAuthProvider.USER_POOLS) {\n                        authModes.add('userPool');\n                    }\n                    else if (rule.provider === types_1.ModelAttributeAuthProvider.OIDC) {\n                        authModes.add('oidc');\n                    }\n                }\n                break;\n            }\n            case types_1.ModelAttributeAuthAllow.PRIVATE: {\n                // We shouldn't attempt private if there isn't an authenticated user\n                if (currentUser) {\n                    // private with no provider means userPools\n                    if (!rule.provider ||\n                        rule.provider === types_1.ModelAttributeAuthProvider.USER_POOLS) {\n                        authModes.add('userPool');\n                    }\n                    else if (rule.provider === types_1.ModelAttributeAuthProvider.IAM) {\n                        authModes.add('iam');\n                    }\n                }\n                break;\n            }\n            case types_1.ModelAttributeAuthAllow.PUBLIC: {\n                if (rule.provider === types_1.ModelAttributeAuthProvider.IAM) {\n                    authModes.add('iam');\n                }\n                else if (!rule.provider ||\n                    rule.provider === types_1.ModelAttributeAuthProvider.API_KEY) {\n                    // public with no provider means apiKey\n                    authModes.add('apiKey');\n                }\n                break;\n            }\n            default:\n                break;\n        }\n    });\n    return Array.from(authModes);\n}\n/**\n * Returns an array of auth modes to try based on the schema, model, and\n * authenticated user (or lack thereof). Rules are sourced from `getAuthRules`\n * and returned in the order they ought to be attempted.\n *\n * @see sortAuthRulesWithPriority\n * @see getAuthRules\n *\n * @param param0 The `{schema, modelName}` to inspect.\n * @returns A sorted array of auth modes to attempt.\n */\nconst multiAuthStrategy = () => async ({ schema, modelName }) => {\n    let currentUser;\n    try {\n        const authSession = await (0, core_1.fetchAuthSession)();\n        if (authSession.tokens.accessToken) {\n            // the user is authenticated\n            currentUser = authSession;\n        }\n    }\n    catch (e) {\n        // No current user\n    }\n    const { attributes } = schema.namespaces.user.models[modelName];\n    if (attributes) {\n        const authAttribute = attributes.find(attr => attr.type === 'auth');\n        if (authAttribute?.properties?.rules) {\n            const sortedRules = sortAuthRulesWithPriority(authAttribute.properties.rules);\n            return getAuthRules({ currentUser, rules: sortedRules });\n        }\n    }\n    return [];\n};\nexports.multiAuthStrategy = multiAuthStrategy;\n"],"names":[],"mappings":"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"}