{"version":3,"file":"createQueuedStorage.native.mjs","sources":["../../../../src/utils/queuedStorage/createQueuedStorage.native.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { loadAsyncStorage } from '@aws-amplify/react-native';\nimport { DATABASE_NAME } from './constants';\nimport { getAddItemBytesSize } from './getAddItemBytesSize';\nexport const keyPrefix = `@${DATABASE_NAME}`;\nexport const createQueuedStorage = () => {\n    let currentBytesSize = 0;\n    let error;\n    const openDBPromise = new Promise((resolve, _reject) => {\n        try {\n            const asyncStorage = loadAsyncStorage();\n            getQueuedItemKeys(asyncStorage)\n                .then(keys => getQueuedItems(asyncStorage, keys))\n                .then(items => {\n                for (const item of items) {\n                    currentBytesSize += item.bytesSize;\n                }\n                return undefined;\n            })\n                .then(__ => {\n                resolve(asyncStorage);\n            });\n        }\n        catch (err) {\n            error = err;\n            resolve(undefined);\n        }\n    });\n    const getAsyncStorage = async () => {\n        const as = await openDBPromise;\n        if (!as) {\n            throw error;\n        }\n        return as;\n    };\n    const _peek = async (n) => {\n        const as = await getAsyncStorage();\n        const queuedItemKeys = await getQueuedItemKeys(as, true);\n        const keysToGetValues = queuedItemKeys.slice(0, n);\n        return getQueuedItems(as, keysToGetValues);\n    };\n    return {\n        async add(item, { dequeueBeforeEnqueue } = { dequeueBeforeEnqueue: false }) {\n            if (dequeueBeforeEnqueue) {\n                const itemsToDelete = await this.peek(1);\n                await this.delete(itemsToDelete);\n            }\n            const as = await getAsyncStorage();\n            const itemBytesSize = getAddItemBytesSize(item);\n            const key = `${keyPrefix}_${Date.now()}`;\n            const queuedItem = {\n                ...item,\n                bytesSize: itemBytesSize,\n                key,\n            };\n            await as.setItem(key, JSON.stringify(queuedItem));\n            currentBytesSize += itemBytesSize;\n        },\n        async peek(n) {\n            return _peek(n);\n        },\n        async peekAll() {\n            return _peek();\n        },\n        async delete(items) {\n            const as = await getAsyncStorage();\n            const keysToDelete = items\n                .map(item => item.key)\n                .filter((id) => id !== undefined);\n            await as.multiRemove(keysToDelete);\n            for (const item of items) {\n                currentBytesSize -= item.bytesSize;\n            }\n        },\n        async clear() {\n            const as = await getAsyncStorage();\n            const keysToDelete = await getQueuedItemKeys(as);\n            await as.multiRemove(keysToDelete);\n            currentBytesSize = 0;\n        },\n        isFull(maxBytesSizeInMiB) {\n            return currentBytesSize >= maxBytesSizeInMiB * 1024 * 1024;\n        },\n    };\n};\nconst getQueuedItemKeys = async (as, sortKeys = false) => {\n    const keys = (await as.getAllKeys()).filter(key => key.startsWith(keyPrefix));\n    return sortKeys\n        ? keys.sort((a, b) => {\n            const timestampA = a.split('_').pop();\n            const timestampB = b.split('_').pop();\n            return parseInt(timestampA) - parseInt(timestampB);\n        })\n        : keys;\n};\nconst getQueuedItems = async (as, keys) => (await as.multiGet(keys))\n    .filter((item) => item[1] !== null)\n    .map(([_, value]) => JSON.parse(value));\n"],"names":[],"mappings":"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"}